# 第十四章 构建自定义的同步工具

## wait 和 notify(notify all) 的使用

### 使用 wait 要注意的问题

* wait 一般与一个条件状态相关联，在条件不满足时 wait
* 调用 wait 时必须持有保护条件状态的锁，否则检查完状态之后到 wait 之间，条件可能已经改变了
* wait 会自动释放当前调用对象的锁
* wait 被唤醒之后要再次检查条件，因为在被唤醒和获得锁之前条件可能又被改变了，而且，wait 也可以等待不同的条件，被唤醒也可能是其他的条件满足了
* 在 while 中判断条件状态，可以保证上面一条得到满足

### 使用 notify(notifyAll) 要注意的问题

* 同样，在调用 notify 时也要获得锁
* notify 之后，尽快释放锁，因为被唤醒的线程也要参与到锁的竞争中，如果 notify 之后线程还长时间持有锁，那被唤醒的线程什么也干不了，只能继续阻塞
* 优先使用 notifyAll，因为 wait 可以在不同的条件状态上进行等待，如果两个线程 A
 和 B 分别在等待 PA 和 PB，此时 PA 满足了，但是 notify 唤醒了线程 B，B 判断未满足，继续等待，A 本应该继续执行，但却没有收到信号，而且，这个信号永远的丢失了
 
> 注意 wait 和 notify 的配对使用，在一个条件上 wait 时，一定要确保有地方在条件变为真时 notify

### 可以使用 notify 的情况

必须同时满足下面两个条件才可以

* 所有 wait 在同一个条件上等待，并且 wait 之后执行的操作相同
* 在条件状态上的每次通知，最多只能唤醒一个线程来执行（也就是不允许唤醒多个）

